name: Build Release

on:
  push:
    branches: [ main ]
    tags:
      - "v*"
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  pack:
    name: Pack MCPB
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate UV manifest
        shell: bash
        run: |
          jq -e '.manifest_version == "0.4" and .server.type == "uv"' manifest.json >/dev/null

      - name: Setup Node (for mcpb CLI)
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Pack .mcpb (validated)
        shell: bash
        run: |
          find . -maxdepth 1 -type f -name "*.mcpb" -print -delete
          npx -y @anthropic-ai/mcpb pack

      - name: Normalize output filename
        shell: bash
        run: |
          python3 - <<'PY'
          import os
          from pathlib import Path

          tag = os.environ.get("GITHUB_REF_NAME", "dev")
          outs = sorted(Path(".").glob("*.mcpb"))
          if len(outs) != 1:
            names = ", ".join(path.name for path in outs) if outs else "(none)"
            raise SystemExit(
                "expected exactly one freshly built .mcpb in repository root; found: "
                + names
            )

          src = outs[0]
          dst = Path(f"lit-lake-{tag}.mcpb")
          if dst.exists():
            dst.unlink()
          src.replace(dst)
          print(f"Renamed {src} -> {dst}")
          PY

      - name: Upload MCPB artifact
        uses: actions/upload-artifact@v4
        with:
          name: mcpb
          path: lit-lake-*.mcpb
          if-no-files-found: error

  release:
    name: Create Release
    needs: pack
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: Download MCPB artifact
        uses: actions/download-artifact@v4
        with:
          name: mcpb
          path: dist

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*.mcpb
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
